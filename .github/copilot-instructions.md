# Repository custom instructions for GitHub Copilot

Project context:
- Home Assistant HACS integration under `custom_components/energy_dispatcher`.
- Goal: Minimize electricity cost by using the battery to avoid imports during expensive hours; default to no export; provide cautious export options and clear manual overrides.
- Accounting should be based on cumulative energy meters (kWh). Handle missing data gracefully.

Language and UX:
- Provide all user-facing strings in English (en) and Swedish (sv). Do not hardcode user-facing text in code; use HA translations.
- Always include units in labels/help text: SEK/kWh, kWh, kW, %, minutes.
- All user-facing strings (UI labels, config flow prompts, options, service descriptions, diagnostics messages, logs shown to users) must be clear and descriptive.
- Keep terminology consistent across the integration.

Internationalization (i18n)
- Do not hardcode user-facing text in Python or YAML. Use Home Assistant's translations (see `custom_components/energy_dispatcher/translations/`).
- Ensure keys exist in both `translations/en.json` and `translations/sv.json`.
- Use parameterized strings instead of concatenation for better translation handling.

Configuration best practices:
- Config flow uses entity selectors with validation:
  - Energy meters: device_class=energy, unit=kWh, state_class in {total, total_increasing}.
  - Price sensor: unit=SEK/kWh.
  - Battery SoC: device_class=battery, unit=%.
  - Battery power: device_class=power, unit=W or kW.
- High-precision numeric inputs (SEK/kWh): allow up to 6 decimals; avoid spinner controls that clamp to 0.001. Prefer number selector in box mode with step 0.000001 or text + Decimal validation.
- Location defaults to HA Home; allow override via a map selector.

Units and numeric inputs
- Always state expected units in labels or help text, and keep units consistent across the UI.
  - Examples: "Max power (kW)", "Battery capacity (kWh)", "Utilization target (%)", "Price threshold (SEK/kWh)", "Balance factor (decimal 0–1)".
- Percentages vs decimals: Prefer percentages (0–100%) for end users. If a decimal is required, explicitly say "decimal 0–1".
- Validate ranges and steps; display clear, actionable errors in both languages (e.g., "Value must be between 0 and 100%").
- Display units alongside values in messages, notifications, and logs that are user-facing.

Planner principles:
- Peak classification by absolute price threshold (SEK/kWh) or percentile (top X%).
- Pre-peak: charge/hold to meet reserve; peak: avoid grid charge and discharge to cover load within limits.
- Export policy: default "never"; optional threshold-based export with SoC margin and power cap; manual "force export" override with TTL.

Rounding/formatting:
- Durations: >= 2h → 15-min steps; < 2h → 5-min steps (e.g., "2 h 15 min").
- Power rounding bands: 10/25/50/100 W depending on magnitude.
- Display prices and kWh with 2 decimals; compute with Decimal at up to 6 decimals.

Naming and API ergonomics
- Publicly exposed names (config entries, services, entity names, options) must be descriptive and self-explanatory in English and Swedish.
- Avoid ambiguous abbreviations; prefer explicit names. Use common abbreviations only when standard (e.g., ID).

Dashboard UX and target audience
- Prioritize ease of use and understanding. The integration targets normal users, not power users.
- Avoid jargon and internal terms; prefer everyday language and brief labels.
- Provide sensible defaults and short, helpful help texts. Keep advanced options optional and well explained.
- Present key metrics with appropriate units, consistent decimal precision, and readable formatting.

Testing:
- Use pytest + HA harness. Load real "as-is" fixtures from `tests/fixtures/` (gaps allowed).
- Provide a data quality report that summarizes coverage, gaps, and non-monotonic meters and suggests "perfect" vs "gappy" windows for tests.

Documentation to keep in sync:
- `docs/price_config_example.md` — price composition and formulas.
- `docs/sample_data_notes.md` — annotate perfect/gappy windows after report.
- `docs/config_precision.md` — precision/selector guidance.
- `docs/generated/sample_data_report.md` — auto-generated by the report script.

Review workflow
- Investigate the previous 2–5 merged PRs, especially those touching the same files/paths as this change.
- If a regression is suspected, cite the related PR numbers and specific files/lines that changed, and propose a concrete fix or revert.
- Prefer diffs or comparisons that show the change timeline (e.g., compare against the last known good commit).
- Cross-reference any linked issues or bug reports; ensure the PR description explains the root cause and prevents recurrence (tests, validation, clearer config, etc.).

Accessibility and clarity
- Messages should be unambiguous and actionable. Provide helpful error/validation text in both languages.

When suggesting changes
- Propose concrete English and Swedish text and point to exact files/lines when possible.
- If a string lacks units or is ambiguous for typical users, recommend clearer wording and include the unit.

Versioning and releases:
- Bump manifest version for releases.
- PRs changing user-facing text must update translations (EN/SV).
